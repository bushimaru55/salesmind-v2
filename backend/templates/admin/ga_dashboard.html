{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrahead %}
{{ block.super }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
    .ga-dashboard {
        padding: 20px;
    }
    
    .ga-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 15px;
        border-bottom: 2px solid #417690;
    }
    
    .ga-header h1 {
        margin: 0;
        color: #417690;
        font-size: 28px;
    }
    
    .ga-header .last-updated {
        color: #666;
        font-size: 14px;
    }
    
    .ga-refresh-btn {
        background: #417690;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .ga-refresh-btn:hover {
        background: #205067;
    }
    
    .ga-refresh-btn:disabled {
        background: #ccc;
        cursor: not-allowed;
    }
    
    .ga-refresh-btn .spinner {
        display: none;
        width: 16px;
        height: 16px;
        border: 2px solid #fff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }
    
    .ga-refresh-btn.loading .spinner {
        display: inline-block;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .ga-stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .ga-stat-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 12px;
        padding: 25px;
        color: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s;
    }
    
    .ga-stat-card:hover {
        transform: translateY(-3px);
    }
    
    .ga-stat-card.realtime {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .ga-stat-card.users {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    .ga-stat-card.pageviews {
        background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
    }
    
    .ga-stat-card.sessions {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .ga-stat-card .label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 8px;
    }
    
    .ga-stat-card .value {
        font-size: 42px;
        font-weight: bold;
        line-height: 1;
    }
    
    .ga-stat-card .icon {
        font-size: 24px;
        margin-bottom: 10px;
    }
    
    .ga-charts-grid {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    @media (max-width: 1200px) {
        .ga-charts-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .ga-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
    }
    
    .ga-card h3 {
        margin: 0 0 20px 0;
        color: #333;
        font-size: 18px;
        border-bottom: 2px solid #f0f0f0;
        padding-bottom: 10px;
    }
    
    .ga-tables-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }
    
    .ga-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .ga-table th,
    .ga-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #eee;
    }
    
    .ga-table th {
        background: #f8f9fa;
        font-weight: 600;
        color: #555;
        font-size: 13px;
    }
    
    .ga-table tr:hover {
        background: #f8f9fa;
    }
    
    .ga-table td:last-child {
        text-align: right;
    }
    
    .ga-table th:last-child {
        text-align: right;
    }
    
    .ga-device-bar {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .ga-device-bar .bar {
        flex: 1;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }
    
    .ga-device-bar .bar-fill {
        height: 100%;
        background: linear-gradient(90deg, #667eea, #764ba2);
        border-radius: 4px;
    }
    
    .ga-device-bar .percentage {
        min-width: 50px;
        text-align: right;
        font-weight: 600;
        color: #555;
    }
    
    .ga-unavailable {
        background: #fff3cd;
        border: 1px solid #ffc107;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        color: #856404;
    }
    
    .ga-unavailable h4 {
        margin: 0 0 10px 0;
    }
    
    .ga-unavailable code {
        background: #f8f9fa;
        padding: 2px 6px;
        border-radius: 3px;
    }
    
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
        .ga-card {
            background: #2d2d2d;
        }
        
        .ga-card h3 {
            color: #eee;
            border-bottom-color: #444;
        }
        
        .ga-table th {
            background: #3d3d3d;
            color: #ccc;
        }
        
        .ga-table td {
            border-bottom-color: #444;
        }
        
        .ga-table tr:hover {
            background: #3d3d3d;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="ga-dashboard">
    <div class="ga-header">
        <div>
            <h1>ğŸ“Š Google Analytics ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</h1>
            <span class="last-updated" id="last-updated">
                æœ€çµ‚æ›´æ–°: {{ ga_data.last_updated }}
            </span>
        </div>
        <button class="ga-refresh-btn" onclick="refreshData()" id="refresh-btn">
            <span class="spinner"></span>
            ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        </button>
    </div>
    
    {% if not ga_data.is_available %}
    <div class="ga-unavailable">
        <h4>âš ï¸ Google Analytics API ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</h4>
        <p>ä»¥ä¸‹ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š</p>
        <ul>
            <li><code>GA_PROPERTY_ID</code> ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã“ã¨</li>
            <li><code>GOOGLE_APPLICATION_CREDENTIALS</code> ãŒæ­£ã—ã„JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŒ‡ã—ã¦ã„ã‚‹ã“ã¨</li>
            <li>ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã«GA4ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©ãŒã‚ã‚‹ã“ã¨</li>
        </ul>
        <p>ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ID: <code>{{ ga_data.property_id|default:"æœªè¨­å®š" }}</code></p>
    </div>
    {% endif %}
    
    <!-- çµ±è¨ˆã‚«ãƒ¼ãƒ‰ -->
    <div class="ga-stats-grid">
        <div class="ga-stat-card realtime">
            <div class="icon">ğŸ‘¥</div>
            <div class="label">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
            <div class="value" id="realtime-users">{{ ga_data.realtime_users }}</div>
        </div>
        <div class="ga-stat-card users">
            <div class="icon">ğŸ‘¤</div>
            <div class="label">ä»Šæ—¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼</div>
            <div class="value" id="today-users">{{ ga_data.today.users }}</div>
        </div>
        <div class="ga-stat-card pageviews">
            <div class="icon">ğŸ“„</div>
            <div class="label">ä»Šæ—¥ã®PV</div>
            <div class="value" id="today-pageviews">{{ ga_data.today.pageviews }}</div>
        </div>
        <div class="ga-stat-card sessions">
            <div class="icon">ğŸ”—</div>
            <div class="label">ä»Šæ—¥ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³</div>
            <div class="value" id="today-sessions">{{ ga_data.today.sessions }}</div>
        </div>
    </div>
    
    <!-- ãƒãƒ£ãƒ¼ãƒˆã‚¨ãƒªã‚¢ -->
    <div class="ga-charts-grid">
        <div class="ga-card">
            <h3>ğŸ“ˆ éå»7æ—¥é–“ã®æ¨ç§»</h3>
            <canvas id="trendChart" height="120"></canvas>
        </div>
        <div class="ga-card">
            <h3>ğŸ“± ãƒ‡ãƒã‚¤ã‚¹åˆ¥</h3>
            <canvas id="deviceChart" height="200"></canvas>
        </div>
    </div>
    
    <!-- ãƒ†ãƒ¼ãƒ–ãƒ«ã‚¨ãƒªã‚¢ -->
    <div class="ga-tables-grid">
        <div class="ga-card">
            <h3>ğŸ”¥ äººæ°—ãƒšãƒ¼ã‚¸ï¼ˆ7æ—¥é–“ï¼‰</h3>
            <table class="ga-table">
                <thead>
                    <tr>
                        <th>ãƒšãƒ¼ã‚¸</th>
                        <th>PV</th>
                    </tr>
                </thead>
                <tbody id="top-pages">
                    {% for page in ga_data.top_pages %}
                    <tr>
                        <td title="{{ page.page }}">{{ page.page|truncatechars:40 }}</td>
                        <td>{{ page.pageviews }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="ga-card">
            <h3>ğŸŒ ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯ã‚½ãƒ¼ã‚¹</h3>
            <table class="ga-table">
                <thead>
                    <tr>
                        <th>ã‚½ãƒ¼ã‚¹</th>
                        <th>ã‚»ãƒƒã‚·ãƒ§ãƒ³</th>
                    </tr>
                </thead>
                <tbody id="traffic-sources">
                    {% for source in ga_data.traffic_sources %}
                    <tr>
                        <td>{{ source.source }}</td>
                        <td>{{ source.sessions }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <div class="ga-card">
            <h3>ğŸŒ ã‚¢ã‚¯ã‚»ã‚¹å›½</h3>
            <table class="ga-table">
                <thead>
                    <tr>
                        <th>å›½</th>
                        <th>ã‚»ãƒƒã‚·ãƒ§ãƒ³</th>
                    </tr>
                </thead>
                <tbody id="countries">
                    {% for country in ga_data.countries %}
                    <tr>
                        <td>{{ country.country }}</td>
                        <td>{{ country.sessions }}</td>
                    </tr>
                    {% empty %}
                    <tr><td colspan="2">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// åˆæœŸãƒ‡ãƒ¼ã‚¿
let gaData = {{ ga_data_json|safe }};

// ãƒãƒ£ãƒ¼ãƒˆã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹
let trendChart = null;
let deviceChart = null;

// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ãƒãƒ£ãƒ¼ãƒˆã‚’åˆæœŸåŒ–
document.addEventListener('DOMContentLoaded', function() {
    console.log('GA Dashboard loaded, data:', gaData);
    initCharts();
});

function initCharts() {
    // ãƒˆãƒ¬ãƒ³ãƒ‰ãƒãƒ£ãƒ¼ãƒˆ
    const trendCtx = document.getElementById('trendChart').getContext('2d');
    const weeklyData = gaData.weekly_trend || [];
    
    trendChart = new Chart(trendCtx, {
        type: 'line',
        data: {
            labels: weeklyData.map(d => d.date),
            datasets: [
                {
                    label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼',
                    data: weeklyData.map(d => d.users),
                    borderColor: '#667eea',
                    backgroundColor: 'rgba(102, 126, 234, 0.1)',
                    fill: true,
                    tension: 0.4
                },
                {
                    label: 'PV',
                    data: weeklyData.map(d => d.pageviews),
                    borderColor: '#43e97b',
                    backgroundColor: 'rgba(67, 233, 123, 0.1)',
                    fill: true,
                    tension: 0.4
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'top'
                }
            },
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
    
    // ãƒ‡ãƒã‚¤ã‚¹ãƒãƒ£ãƒ¼ãƒˆ
    const deviceCtx = document.getElementById('deviceChart').getContext('2d');
    const deviceData = gaData.devices || [];
    
    deviceChart = new Chart(deviceCtx, {
        type: 'doughnut',
        data: {
            labels: deviceData.map(d => d.device),
            datasets: [{
                data: deviceData.map(d => d.sessions),
                backgroundColor: [
                    '#667eea',
                    '#43e97b',
                    '#fa709a',
                    '#4facfe',
                    '#f5576c'
                ]
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

function refreshData() {
    const btn = document.getElementById('refresh-btn');
    btn.classList.add('loading');
    btn.disabled = true;
    
    fetch('/admin/analytics/api/', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        console.log('Response status:', response.status);
        if (!response.ok) {
            throw new Error('HTTP error! status: ' + response.status);
        }
        return response.json();
    })
    .then(data => {
        console.log('Received data:', data);
        gaData = data;
        updateUI();
        btn.classList.remove('loading');
        btn.disabled = false;
    })
    .catch(error => {
        console.error('Refresh error:', error);
        btn.classList.remove('loading');
        btn.disabled = false;
        // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã—ãªã„ï¼ˆãƒ‡ãƒ¼ã‚¿ã¯åˆå›ãƒ­ãƒ¼ãƒ‰ã§å–å¾—æ¸ˆã¿ï¼‰
    });
}

function updateUI() {
    // çµ±è¨ˆã‚«ãƒ¼ãƒ‰æ›´æ–°
    document.getElementById('realtime-users').textContent = gaData.realtime_users;
    document.getElementById('today-users').textContent = gaData.today.users;
    document.getElementById('today-pageviews').textContent = gaData.today.pageviews;
    document.getElementById('today-sessions').textContent = gaData.today.sessions;
    document.getElementById('last-updated').textContent = 'æœ€çµ‚æ›´æ–°: ' + gaData.last_updated;
    
    // ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°
    if (trendChart) {
        const weeklyData = gaData.weekly_trend || [];
        trendChart.data.labels = weeklyData.map(d => d.date);
        trendChart.data.datasets[0].data = weeklyData.map(d => d.users);
        trendChart.data.datasets[1].data = weeklyData.map(d => d.pageviews);
        trendChart.update();
    }
    
    if (deviceChart) {
        const deviceData = gaData.devices || [];
        deviceChart.data.labels = deviceData.map(d => d.device);
        deviceChart.data.datasets[0].data = deviceData.map(d => d.sessions);
        deviceChart.update();
    }
    
    // ãƒ†ãƒ¼ãƒ–ãƒ«æ›´æ–°
    updateTable('top-pages', gaData.top_pages, ['page', 'pageviews']);
    updateTable('traffic-sources', gaData.traffic_sources, ['source', 'sessions']);
    updateTable('countries', gaData.countries, ['country', 'sessions']);
}

function updateTable(tableId, data, columns) {
    const tbody = document.getElementById(tableId);
    if (!tbody) return;
    
    if (!data || data.length === 0) {
        tbody.innerHTML = '<tr><td colspan="2">ãƒ‡ãƒ¼ã‚¿ãªã—</td></tr>';
        return;
    }
    
    tbody.innerHTML = data.map(row => {
        const cells = columns.map((col, i) => {
            const value = row[col];
            if (i === 0 && col === 'page') {
                return `<td title="${value}">${value.substring(0, 40)}${value.length > 40 ? '...' : ''}</td>`;
            }
            return `<td>${value}</td>`;
        }).join('');
        return `<tr>${cells}</tr>`;
    }).join('');
}

// 30ç§’ã”ã¨ã«è‡ªå‹•æ›´æ–°ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰
setInterval(function() {
    fetch('/admin/analytics/api/', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        },
        credentials: 'same-origin'
    })
    .then(response => {
        if (!response.ok) throw new Error('HTTP error');
        return response.json();
    })
    .then(data => {
        document.getElementById('realtime-users').textContent = data.realtime_users;
        document.getElementById('last-updated').textContent = 'æœ€çµ‚æ›´æ–°: ' + data.last_updated;
    })
    .catch(error => console.log('Auto-refresh error:', error));
}, 30000);
</script>
{% endblock %}

