# ã‚³ãƒ¼ãƒ‰æ§‹é€ æ”¹å–„è¨ˆç”»æ›¸ - ãƒ¢ãƒ¼ãƒ‰åˆ†é›¢ã®å¼·åŒ–

## ğŸ“‹ æ¦‚è¦

ç°¡æ˜“è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã¨è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã®æ©Ÿèƒ½å·®ãŒå¤§ãããªã‚‹ã“ã¨ã‚’å‰æã«ã€ã‚³ãƒ¼ãƒ‰æ§‹é€ ã‚’æ”¹å–„ã—ã€å•é¡Œã®åˆ‡ã‚Šåˆ†ã‘ã‚’å®¹æ˜“ã«ã™ã‚‹ã€‚

## ğŸ¯ æ”¹å–„ç›®æ¨™

1. **ãƒ¢ãƒ¼ãƒ‰ã®æ˜ç¤ºçš„ãªè­˜åˆ¥**: `Session`ãƒ¢ãƒ‡ãƒ«ã«`mode`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
2. **ãƒ­ã‚°ã®æ”¹å–„**: ã™ã¹ã¦ã®ãƒ­ã‚°ã«ãƒ¢ãƒ¼ãƒ‰æƒ…å ±ã‚’å«ã‚ã‚‹
3. **ã‚¨ãƒ©ãƒ¼æ™‚ã®åˆ‡ã‚Šåˆ†ã‘**: ãƒ¢ãƒ¼ãƒ‰æƒ…å ±ã‚’æ´»ç”¨ã—ãŸãƒ‡ãƒãƒƒã‚°ã®å®¹æ˜“åŒ–
4. **å°†æ¥ã®æ‹¡å¼µæ€§**: æ–°ã—ã„ãƒ¢ãƒ¼ãƒ‰è¿½åŠ ã«å¯¾å¿œå¯èƒ½ãªæ§‹é€ 

## ğŸ“ å®Ÿè£…è¨ˆç”»

### Phase 1: ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆã®æ”¹å–„ï¼ˆæœ€å„ªå…ˆï¼‰

#### 1.1 Sessionãƒ¢ãƒ‡ãƒ«ã«`mode`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 

**å¤‰æ›´å†…å®¹:**
```python
class Session(models.Model):
    MODE_CHOICES = [
        ('simple', 'ç°¡æ˜“è¨ºæ–­'),
        ('detailed', 'è©³ç´°è¨ºæ–­'),
    ]
    
    mode = models.CharField(
        max_length=20, 
        choices=MODE_CHOICES, 
        default='simple',
        help_text="è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ï¼ˆç°¡æ˜“è¨ºæ–­ã¾ãŸã¯è©³ç´°è¨ºæ–­ï¼‰"
    )
    # ... æ—¢å­˜ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰
```

**å½±éŸ¿ç¯„å›²:**
- `backend/spin/models.py`
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆæ–°è¦ä½œæˆï¼‰
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œã‚¹ã‚¯ãƒªãƒ—ãƒˆï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰

**æ³¨æ„äº‹é …:**
- `default='simple'`ã§æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã¯ã™ã¹ã¦ç°¡æ˜“è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã«ãªã‚‹
- æ—¢å­˜ã®è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¯`company`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®æœ‰ç„¡ã§åˆ¤å®šã—ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚ã«è¨­å®š

#### 1.2 ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

**æ‰‹é †:**
1. Djangoãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚³ãƒãƒ³ãƒ‰ã§è‡ªå‹•ç”Ÿæˆ
2. ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ ï¼ˆæ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®`mode`ã‚’è¨­å®šï¼‰

**ç§»è¡Œãƒ­ã‚¸ãƒƒã‚¯:**
```python
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œ
def set_mode_from_company(apps, schema_editor):
    Session = apps.get_model('spin', 'Session')
    # companyãŒã‚ã‚‹å ´åˆã¯è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã€ãªã„å ´åˆã¯ç°¡æ˜“è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰
    Session.objects.filter(company__isnull=False).update(mode='detailed')
    Session.objects.filter(company__isnull=True).update(mode='simple')
```

**æ³¨æ„äº‹é …:**
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒå¤§é‡ã«ã‚ã‚‹å ´åˆã¯ã€æ®µéšçš„ã«ç§»è¡Œ
- æœ¬ç•ªç’°å¢ƒã§ã¯ç§»è¡Œå‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—

### Phase 2: ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã®æ›´æ–°

#### 2.1 SessionSerializerã®æ›´æ–°

**å¤‰æ›´å†…å®¹:**
```python
class SessionSerializer(serializers.ModelSerializer):
    company_id = serializers.UUIDField(write_only=True, required=False, allow_null=True)
    company = CompanySerializer(read_only=True)
    industry = serializers.CharField(max_length=100, required=False, allow_blank=True)
    mode = serializers.ChoiceField(choices=Session.MODE_CHOICES, required=False)
    
    # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰
    
    def validate(self, attrs):
        company_id = attrs.get('company_id')
        mode = attrs.get('mode')
        industry = attrs.get('industry', '')
        
        # modeãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã€company_idã®æœ‰ç„¡ã§åˆ¤å®š
        if not mode:
            if company_id:
                attrs['mode'] = 'detailed'
            else:
                attrs['mode'] = 'simple'
        
        # ç°¡æ˜“è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€æ¥­ç•Œã¯å¿…é ˆ
        if attrs.get('mode') == 'simple' and (not industry or not industry.strip()):
            raise serializers.ValidationError({"industry": "æ¥­ç•Œã¯å¿…é ˆã§ã™ï¼ˆç°¡æ˜“è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ï¼‰"})
        
        # è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã€company_idã¯å¿…é ˆ
        if attrs.get('mode') == 'detailed' and not company_id:
            raise serializers.ValidationError({"company_id": "ä¼æ¥­æƒ…å ±ã¯å¿…é ˆã§ã™ï¼ˆè©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ï¼‰"})
        
        return attrs
```

**å½±éŸ¿ç¯„å›²:**
- `backend/spin/serializers.py`

**æ³¨æ„äº‹é …:**
- å¾Œæ–¹äº’æ›æ€§ã‚’ä¿ã¤ãŸã‚ã€`mode`ãŒæŒ‡å®šã•ã‚Œãªã„å ´åˆã¯è‡ªå‹•åˆ¤å®š
- `company_id`ã¨`mode`ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚’è¿½åŠ 

### Phase 3: ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°

#### 3.1 start_sessionãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°

**å¤‰æ›´å†…å®¹:**
```python
@api_view(['POST'])
@permission_classes([IsAuthenticated])
def start_session(request):
    """ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å§‹ã™ã‚‹ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ"""
    serializer = SessionSerializer(data=request.data, context={'request': request})
    if serializer.is_valid():
        session = serializer.save(user=request.user, status='active')
        logger.info(f"Session started: {session.id}, mode={session.mode}, user={request.user.username}")
        return Response(SessionSerializer(session).data, status=status.HTTP_201_CREATED)
    logger.warning(f"Session start validation failed: {serializer.errors}")
    return Response(serializer.errors, status=status.HTTP_400_BAD_REQUEST)
```

**å½±éŸ¿ç¯„å›²:**
- `backend/spin/views.py`

**æ³¨æ„äº‹é …:**
- ãƒ­ã‚°ã«`mode`æƒ…å ±ã‚’å«ã‚ã‚‹

### Phase 4: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®æ›´æ–°

#### 4.1 openai_client.pyã®æ›´æ–°

**å¤‰æ›´å†…å®¹:**
```python
def generate_customer_response(session, conversation_history):
    """é¡§å®¢ãƒ­ãƒ¼ãƒ«ãƒ—ãƒ¬ã‚¤ç”¨ã®å¿œç­”ã‚’ç”Ÿæˆ"""
    logger.info(f"AIé¡§å®¢å¿œç­”ç”Ÿæˆã‚’é–‹å§‹: Session {session.id}, mode={session.mode}")
    
    # è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿ä¼æ¥­æƒ…å ±ã‚’å–å¾—
    company_info_text = ""
    if session.mode == 'detailed' and session.company:
        # ... æ—¢å­˜ã®ä¼æ¥­æƒ…å ±å–å¾—ãƒ­ã‚¸ãƒƒã‚¯
    
    # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰
    
    logger.info(f"AIé¡§å®¢å¿œç­”ç”ŸæˆãŒå®Œäº†: Session {session.id}, mode={session.mode}")
```

**å½±éŸ¿ç¯„å›²:**
- `backend/spin/services/openai_client.py`

**æ³¨æ„äº‹é …:**
- `session.company`ã ã‘ã§ãªã`session.mode`ã‚‚ãƒã‚§ãƒƒã‚¯
- ãƒ­ã‚°ã«`mode`æƒ…å ±ã‚’å«ã‚ã‚‹

#### 4.2 scoring.pyã®æ›´æ–°

**å¤‰æ›´å†…å®¹:**
```python
def score_conversation(session, conversation_history):
    """ä¼šè©±å±¥æ­´ã‚’åˆ†æã—ã¦ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚’å®Ÿè¡Œ"""
    logger.info(f"ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°é–‹å§‹: Session {session.id}, mode={session.mode}, ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸æ•°: {len(conversation_history)}")
    
    # è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã®ã¿ä¼æ¥­æƒ…å ±ã‚’å–å¾—
    company_info_text = ""
    if session.mode == 'detailed' and session.company:
        # ... æ—¢å­˜ã®ä¼æ¥­æƒ…å ±å–å¾—ãƒ­ã‚¸ãƒƒã‚¯
    
    # ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰
    
    logger.info(f"ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°å®Œäº†: Session {session.id}, mode={session.mode}")
```

**å½±éŸ¿ç¯„å›²:**
- `backend/spin/services/scoring.py`

**æ³¨æ„äº‹é …:**
- `session.company`ã ã‘ã§ãªã`session.mode`ã‚‚ãƒã‚§ãƒƒã‚¯
- ãƒ­ã‚°ã«`mode`æƒ…å ±ã‚’å«ã‚ã‚‹

### Phase 5: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æ›´æ–°

#### 5.1 ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã«modeã‚’æ˜ç¤ºçš„ã«é€ä¿¡

**å¤‰æ›´å†…å®¹:**
```javascript
// ç°¡æ˜“è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰
async function startDiagnosis() {
    // ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰
    
    body: JSON.stringify({
        mode: 'simple',  // æ˜ç¤ºçš„ã«modeã‚’æŒ‡å®š
        industry,
        value_proposition,
        customer_persona: customer_persona || undefined,
        customer_pain: null
    })
}

// è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰
async function startDetailedDiagnosis() {
    // ... æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰
    
    body: JSON.stringify({
        mode: 'detailed',  // æ˜ç¤ºçš„ã«modeã‚’æŒ‡å®š
        value_proposition: value_proposition,
        customer_persona: customer_persona || undefined,
        customer_pain: null,
        company_id: currentCompanyId
    })
}
```

**å½±éŸ¿ç¯„å›²:**
- `frontend/app.js`

**æ³¨æ„äº‹é …:**
- æ—¢å­˜ã®`currentMode`å¤‰æ•°ã‚’æ´»ç”¨
- ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§`mode`æƒ…å ±ã‚’ãƒ­ã‚°ã«å«ã‚ã‚‹

#### 5.2 ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„

**å¤‰æ›´å†…å®¹:**
```javascript
// ã‚¨ãƒ©ãƒ¼æ™‚ã«modeæƒ…å ±ã‚’å«ã‚ã‚‹
if (window.logger) {
    window.logger.error('è¨ºæ–­é–‹å§‹ã‚¨ãƒ©ãƒ¼', { 
        mode: currentMode,
        message: error.message, 
        stack: error.stack, 
        errorType: error.name 
    });
}
```

**å½±éŸ¿ç¯„å›²:**
- `frontend/app.js`

## ğŸ”„ å®Ÿè£…æ‰‹é †ï¼ˆã‚¨ãƒ©ãƒ¼é˜²æ­¢ã®ãŸã‚æ®µéšçš„ã«å®Ÿæ–½ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—1: æº–å‚™ãƒ•ã‚§ãƒ¼ã‚ºï¼ˆé‡è¦ï¼šå®Ÿè£…å‰ã®ç¢ºèªï¼‰
1. **ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ã‚’ç¢ºèª**
   ```bash
   python manage.py shell
   >>> from spin.models import Session
   >>> Session.objects.count()  # æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã‚’ç¢ºèª
   >>> Session.objects.filter(company__isnull=False).count()  # è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°
   ```

2. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å–å¾—ï¼ˆæœ¬ç•ªç’°å¢ƒã®å ´åˆï¼‰**
   ```bash
   # PostgreSQLã®å ´åˆ
   pg_dump salesmind > backup_before_migration.sql
   ```

3. **Gitã§ç¾åœ¨ã®çŠ¶æ…‹ã‚’ã‚³ãƒŸãƒƒãƒˆ**
   ```bash
   git add -A
   git commit -m "ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—: modeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ å‰ã®çŠ¶æ…‹"
   ```

### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ¢ãƒ‡ãƒ«ã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®æº–å‚™
1. **`Session`ãƒ¢ãƒ‡ãƒ«ã«`mode`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ **
   - `backend/spin/models.py`ã‚’ç·¨é›†
   - `MODE_CHOICES`ã‚’è¿½åŠ 
   - `mode`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ï¼ˆ`default='simple'`ï¼‰

2. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ**
   ```bash
   cd backend
   python manage.py makemigrations spin
   ```

3. **ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ **
   - è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç·¨é›†
   - `RunPython`ã‚’ä½¿ã£ã¦æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®`mode`ã‚’è¨­å®š

4. **ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ†ã‚¹ãƒˆ**
   ```bash
   python manage.py migrate
   ```

5. **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®`mode`ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª**
   ```bash
   python manage.py shell
   >>> from spin.models import Session
   >>> # ç°¡æ˜“è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   >>> Session.objects.filter(mode='simple').count()
   >>> # è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒæ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
   >>> Session.objects.filter(mode='detailed').count()
   >>> # æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼šcompanyãŒã‚ã‚‹ã®ã«mode='simple'ã¯ãªã„ã‹
   >>> Session.objects.filter(company__isnull=False, mode='simple').count()  # 0ã§ã‚ã‚‹ã¹ã
   >>> # æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼šcompanyãŒãªã„ã®ã«mode='detailed'ã¯ãªã„ã‹
   >>> Session.objects.filter(company__isnull=True, mode='detailed').count()  # 0ã§ã‚ã‚‹ã¹ã
   ```

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®æ›´æ–°
1. **`SessionSerializer`ã‚’æ›´æ–°ï¼ˆå¾Œæ–¹äº’æ›æ€§ã‚’ä¿ã¤ï¼‰**
   - `mode`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ï¼ˆ`required=False`ï¼‰
   - `validate`ãƒ¡ã‚½ãƒƒãƒ‰ã§`mode`ã®è‡ªå‹•åˆ¤å®šã¨æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

2. **`start_session`ãƒ“ãƒ¥ãƒ¼ã‚’æ›´æ–°**
   - ãƒ­ã‚°ã«`mode`æƒ…å ±ã‚’å«ã‚ã‚‹

3. **`generate_customer_response`ã‚’æ›´æ–°**
   - `session.mode == 'detailed'`ã‚’ãƒã‚§ãƒƒã‚¯
   - ãƒ­ã‚°ã«`mode`æƒ…å ±ã‚’å«ã‚ã‚‹

4. **`score_conversation`ã‚’æ›´æ–°**
   - `session.mode == 'detailed'`ã‚’ãƒã‚§ãƒƒã‚¯
   - ãƒ­ã‚°ã«`mode`æƒ…å ±ã‚’å«ã‚ã‚‹

5. **å„é–¢æ•°ã®ãƒ­ã‚°ã«`mode`ã‚’å«ã‚ã‚‹**
   - ã™ã¹ã¦ã®ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«`mode={session.mode}`ã‚’è¿½åŠ 

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æ›´æ–°
1. **ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã«`mode`ã‚’æ˜ç¤ºçš„ã«é€ä¿¡**
   - `startDiagnosis()`: `mode: 'simple'`ã‚’è¿½åŠ 
   - `startDetailedDiagnosis()`: `mode: 'detailed'`ã‚’è¿½åŠ 

2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã§`mode`æƒ…å ±ã‚’ãƒ­ã‚°ã«å«ã‚ã‚‹**
   - ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«`mode: currentMode`ã‚’è¿½åŠ 

3. **ãƒ–ãƒ©ã‚¦ã‚¶ã§å‹•ä½œç¢ºèª**
   - ç°¡æ˜“è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œç¢ºèª
   - è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã§å‹•ä½œç¢ºèª

### ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ†ã‚¹ãƒˆ
1. **ç°¡æ˜“è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ â†’ å‹•ä½œç¢ºèª**
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãŒæˆåŠŸã™ã‚‹ã‹
   - `mode='simple'`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
   - ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹
   - ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹

2. **è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ â†’ å‹•ä½œç¢ºèª**
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãŒæˆåŠŸã™ã‚‹ã‹
   - `mode='detailed'`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
   - ä¼æ¥­æƒ…å ±ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹
   - ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹
   - ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ã‹

3. **æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ â†’ å‹•ä½œç¢ºèª**
   - æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹
   - æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³è©³ç´°ãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹
   - æ—¢å­˜ã®ãƒ¬ãƒãƒ¼ãƒˆãŒè¡¨ç¤ºã•ã‚Œã‚‹ã‹

4. **ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆ**
   - `mode`ãªã—ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ â†’ è‡ªå‹•åˆ¤å®šã•ã‚Œã‚‹ã‹
   - `mode='simple'`ãªã®ã«`company_id`ã‚’æŒ‡å®š â†’ ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã‹
   - `mode='detailed'`ãªã®ã«`company_id`ãªã— â†’ ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã‹

## âš ï¸ æ³¨æ„äº‹é …ãƒ»ãƒªã‚¹ã‚¯ç®¡ç†

### ãƒªã‚¹ã‚¯1: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§
**ãƒªã‚¹ã‚¯å†…å®¹:**
- æ—¢å­˜ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ã§`mode`ãŒæ­£ã—ãè¨­å®šã•ã‚Œãªã„
- `company`ãŒã‚ã‚‹ã®ã«`mode='simple'`ã«ãªã‚‹
- `company`ãŒãªã„ã®ã«`mode='detailed'`ã«ãªã‚‹

**å¯¾ç­–:**
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰ã«ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ­ã‚¸ãƒƒã‚¯ã‚’å®Ÿè¡Œ
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã«ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ
- æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯SQLï¼š
  ```sql
  -- companyãŒã‚ã‚‹ã®ã«mode='simple'ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„ã‹ç¢ºèª
  SELECT COUNT(*) FROM spin_session WHERE company_id IS NOT NULL AND mode = 'simple';
  
  -- companyãŒãªã„ã®ã«mode='detailed'ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„ã‹ç¢ºèª
  SELECT COUNT(*) FROM spin_session WHERE company_id IS NULL AND mode = 'detailed';
  ```

### ãƒªã‚¹ã‚¯2: å¾Œæ–¹äº’æ›æ€§ã®ç¶­æŒ
**ãƒªã‚¹ã‚¯å†…å®¹:**
- æ—¢å­˜ã®APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒ`mode`ã‚’é€ä¿¡ã—ãªã„å ´åˆã®å‹•ä½œ
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒå¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®å ´åˆã®å‹•ä½œ

**å¯¾ç­–:**
- `mode`ãŒæŒ‡å®šã•ã‚Œãªã„å ´åˆã¯è‡ªå‹•åˆ¤å®šï¼ˆ`company_id`ã®æœ‰ç„¡ã§ï¼‰
- æ—¢å­˜ã®APIã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒå‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
- `SessionSerializer`ã®`validate`ãƒ¡ã‚½ãƒƒãƒ‰ã§`mode`ã®è‡ªå‹•åˆ¤å®šã‚’å®Ÿè£…
- å¾Œæ–¹äº’æ›æ€§ã‚’ç¶­æŒã—ãŸã¾ã¾æ®µéšçš„ã«ç§»è¡Œ

### ãƒªã‚¹ã‚¯3: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å¤±æ•—
**ãƒªã‚¹ã‚¯å†…å®¹:**
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã®ã‚¨ãƒ©ãƒ¼
- ãƒ‡ãƒ¼ã‚¿ç§»è¡Œãƒ­ã‚¸ãƒƒã‚¯ã®ãƒã‚°
- æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®æå¤±

**å¯¾ç­–:**
- ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ååˆ†ã«ãƒ†ã‚¹ãƒˆ
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œï¼ˆDjangoã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå‹•ä½œï¼‰
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰ã«ãƒ‡ãƒ¼ã‚¿ã®æ•´åˆæ€§ã‚’ç¢ºèª
- æœ¬ç•ªç’°å¢ƒã§ã¯ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“ã‚’è¨­å®š
- ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã‚’æº–å‚™ï¼ˆãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®é€†æ“ä½œï¼‰
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå‰ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—

### ãƒªã‚¹ã‚¯4: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¨ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¸æ•´åˆ
**ãƒªã‚¹ã‚¯å†…å®¹:**
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒ`mode`ã‚’é€ä¿¡ã—ãªã„
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒé–“é•ã£ãŸ`mode`ã‚’é€ä¿¡
- `company_id`ã¨`mode`ã®ä¸æ•´åˆ

**å¯¾ç­–:**
- ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã§`mode`ã‚’æ˜ç¤ºçš„ã«é€ä¿¡
- ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§`mode`ã¨`company_id`ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…
- ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ä¸æ•´åˆã‚’æ˜ç¢ºã«è¡¨ç¤º
- `SessionSerializer`ã®`validate`ãƒ¡ã‚½ãƒƒãƒ‰ã§æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯

### ãƒªã‚¹ã‚¯5: æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®æŒ™å‹•å¤‰æ›´
**ãƒªã‚¹ã‚¯å†…å®¹:**
- `session.company`ã®ãƒã‚§ãƒƒã‚¯ãŒ`session.mode == 'detailed'`ã«å¤‰æ›´ã•ã‚Œã‚‹
- æ—¢å­˜ã®æ¡ä»¶åˆ†å²ãƒ­ã‚¸ãƒƒã‚¯ãŒå½±éŸ¿ã‚’å—ã‘ã‚‹

**å¯¾ç­–:**
- ä¸¡æ–¹ã®ãƒã‚§ãƒƒã‚¯ã‚’ä½µç”¨ï¼ˆ`session.mode == 'detailed' and session.company`ï¼‰
- æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ãƒ‘ã‚¹ã‚’å£Šã•ãªã„ã‚ˆã†ã«æ³¨æ„
- æ®µéšçš„ã«ç§»è¡Œï¼ˆã¾ãš`mode`ã‚’è¿½åŠ ã—ã€æ¬¡ã«ãƒ­ã‚¸ãƒƒã‚¯ã‚’æ›´æ–°ï¼‰

### ãƒªã‚¹ã‚¯6: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã¸ã®å½±éŸ¿
**ãƒªã‚¹ã‚¯å†…å®¹:**
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚ã®é•·æ™‚é–“ãƒ­ãƒƒã‚¯
- å¤§é‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ™‚é–“

**å¯¾ç­–:**
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°ã‚’ç¢ºèª
- å¤§é‡ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã¯ã€æ®µéšçš„ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆä¾‹ï¼š100ä»¶ãšã¤ï¼‰
- æœ¬ç•ªç’°å¢ƒã§ã¯ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ™‚é–“ã‚’è¨­å®š
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œæ™‚é–“ã‚’æ¸¬å®š

## ğŸ” äº‹å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆå®Ÿè£…å‰ï¼‰

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª
- [ ] æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: `Session.objects.count()`
- [ ] è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: `Session.objects.filter(company__isnull=False).count()`
- [ ] ç°¡æ˜“è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: `Session.objects.filter(company__isnull=True).count()`

### ã‚³ãƒ¼ãƒ‰ç¢ºèª
- [ ] `session.company`ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹ç®‡æ‰€ã‚’ç‰¹å®š
- [ ] `SessionSerializer`ã®ä½¿ç”¨ç®‡æ‰€ã‚’ç¢ºèª
- [ ] æ—¢å­˜ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª

### ãƒ†ã‚¹ãƒˆç’°å¢ƒç¢ºèª
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæœ€æ–°ã®çŠ¶æ…‹ã‹
- [ ] ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãŒæº–å‚™ã•ã‚Œã¦ã„ã‚‹ã‹
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå–å¾—ã§ãã‚‹ã‹

## ğŸ”§ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè£…ã®è©³ç´°

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®æ§‹é€ 

```python
from django.db import migrations, models

def set_mode_from_company(apps, schema_editor):
    """æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®modeã‚’companyã®æœ‰ç„¡ã§è¨­å®š"""
    Session = apps.get_model('spin', 'Session')
    
    # companyãŒã‚ã‚‹å ´åˆã¯è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰
    Session.objects.filter(company__isnull=False).update(mode='detailed')
    
    # companyãŒãªã„å ´åˆã¯ç°¡æ˜“è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰
    Session.objects.filter(company__isnull=True).update(mode='simple')
    
    # æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ï¼ˆå¿µã®ãŸã‚ï¼‰
    detailed_without_company = Session.objects.filter(mode='detailed', company__isnull=True).count()
    simple_with_company = Session.objects.filter(mode='simple', company__isnull=False).count()
    
    if detailed_without_company > 0 or simple_with_company > 0:
        raise ValueError(f"ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚¨ãƒ©ãƒ¼: detailed_without_company={detailed_without_company}, simple_with_company={simple_with_company}")

class Migration(migrations.Migration):
    dependencies = [
        ('spin', '0002_company_session_company_companyanalysis_and_more'),
    ]

    operations = [
        # 1. ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ï¼ˆnull=True, default='simple'ã§ä¸€æ™‚çš„ã«è¿½åŠ ï¼‰
        migrations.AddField(
            model_name='session',
            name='mode',
            field=models.CharField(
                choices=[('simple', 'ç°¡æ˜“è¨ºæ–­'), ('detailed', 'è©³ç´°è¨ºæ–­')],
                default='simple',
                help_text='è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ï¼ˆç°¡æ˜“è¨ºæ–­ã¾ãŸã¯è©³ç´°è¨ºæ–­ï¼‰',
                max_length=20
            ),
        ),
        
        # 2. ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚’å®Ÿè¡Œ
        migrations.RunPython(set_mode_from_company, migrations.RunPython.noop),
        
        # 3. ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’not nullã«å¤‰æ›´ï¼ˆdefaultã‚’å‰Šé™¤ï¼‰
        migrations.AlterField(
            model_name='session',
            name='mode',
            field=models.CharField(
                choices=[('simple', 'ç°¡æ˜“è¨ºæ–­'), ('detailed', 'è©³ç´°è¨ºæ–­')],
                help_text='è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ï¼ˆç°¡æ˜“è¨ºæ–­ã¾ãŸã¯è©³ç´°è¨ºæ–­ï¼‰',
                max_length=20,
                default='simple'  # ã“ã®å¾Œã€defaultã‚’å‰Šé™¤ã™ã‚‹
            ),
        ),
    ]
```

**æ³¨æ„äº‹é …:**
- `RunPython`ã§ãƒ‡ãƒ¼ã‚¿ç§»è¡Œã‚’å®Ÿè¡Œ
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—æ™‚ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†ï¼ˆ`migrations.RunPython.noop`ï¼‰
- æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚’ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å†…ã§å®Ÿè¡Œ

## ğŸ“Š æ¤œè¨¼ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ¢ãƒ‡ãƒ«
- [ ] `Session`ãƒ¢ãƒ‡ãƒ«ã«`mode`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
- [ ] `MODE_CHOICES`ãŒæ­£ã—ãå®šç¾©ã•ã‚Œã¦ã„ã‚‹
- [ ] `default='simple'`ãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒä½œæˆã•ã‚Œã¦ã„ã‚‹
- [ ] æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç§»è¡Œãƒ­ã‚¸ãƒƒã‚¯ãŒå«ã¾ã‚Œã¦ã„ã‚‹
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒæˆåŠŸã™ã‚‹
- [ ] æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®`mode`ãŒæ­£ã—ãè¨­å®šã•ã‚Œã‚‹

### ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼
- [ ] `SessionSerializer`ã«`mode`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¿½åŠ ã•ã‚Œã¦ã„ã‚‹
- [ ] `validate`ãƒ¡ã‚½ãƒƒãƒ‰ã§`mode`ã®è‡ªå‹•åˆ¤å®šãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] `company_id`ã¨`mode`ã®æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ãŒæ©Ÿèƒ½ã™ã‚‹
- [ ] å¾Œæ–¹äº’æ›æ€§ãŒä¿ãŸã‚Œã¦ã„ã‚‹ï¼ˆ`mode`ãªã—ã§ã‚‚å‹•ä½œï¼‰

### ãƒ“ãƒ¥ãƒ¼
- [ ] `start_session`ãƒ“ãƒ¥ãƒ¼ã§`mode`ãŒæ­£ã—ãå‡¦ç†ã•ã‚Œã‚‹
- [ ] ãƒ­ã‚°ã«`mode`æƒ…å ±ãŒå«ã¾ã‚Œã‚‹

### ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯
- [ ] `generate_customer_response`ã§`mode`ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹
- [ ] `score_conversation`ã§`mode`ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹
- [ ] ãƒ­ã‚°ã«`mode`æƒ…å ±ãŒå«ã¾ã‚Œã‚‹

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- [ ] ç°¡æ˜“è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã§`mode='simple'`ã‚’é€ä¿¡ã—ã¦ã„ã‚‹
- [ ] è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã§`mode='detailed'`ã‚’é€ä¿¡ã—ã¦ã„ã‚‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ­ã‚°ã«`mode`æƒ…å ±ãŒå«ã¾ã‚Œã‚‹

### å‹•ä½œç¢ºèª
- [ ] ç°¡æ˜“è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãŒæˆåŠŸã™ã‚‹
- [ ] è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã§ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãŒæˆåŠŸã™ã‚‹
- [ ] ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°æ©Ÿèƒ½ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹
- [ ] æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹

## ğŸ”§ ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †

ã‚‚ã—å•é¡ŒãŒç™ºç”Ÿã—ãŸå ´åˆï¼š

### ã‚¹ãƒ†ãƒƒãƒ—1: ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
```bash
cd backend
python manage.py migrate spin 0002_company_session_company_companyanalysis_and_more
```
**æ³¨æ„:** ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã™ã‚‹å¿…è¦ãŒã‚ã‚‹å ´åˆã¯ã€æ‰‹å‹•ã§å‰Šé™¤

### ã‚¹ãƒ†ãƒƒãƒ—2: ã‚³ãƒ¼ãƒ‰ã®ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
```bash
git revert <ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥>
# ã¾ãŸã¯
git reset --hard <ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥>
```

### ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©å…ƒï¼ˆå¿…è¦ã«å¿œã˜ã¦ï¼‰
```bash
# PostgreSQLã®å ´åˆ
psql salesmind < backup_before_migration.sql
```

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯å¾Œã®ç¢ºèª
```bash
python manage.py shell
>>> from spin.models import Session
>>> # modeãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒå­˜åœ¨ã—ãªã„ã“ã¨ã‚’ç¢ºèª
>>> hasattr(Session, 'mode')  # Falseã§ã‚ã‚‹ã¹ã
```

## ğŸ” å½±éŸ¿ã‚’å—ã‘ã‚‹ã‚³ãƒ¼ãƒ‰ç®‡æ‰€ã®ä¸€è¦§

### session.companyã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹ç®‡æ‰€

1. **backend/spin/services/openai_client.py**
   - `generate_customer_response()`é–¢æ•°
   - è¡Œç•ªå·: ç´„15è¡Œç›®
   - å¤‰æ›´: `if session.company:` â†’ `if session.mode == 'detailed' and session.company:`

2. **backend/spin/services/scoring.py**
   - `score_conversation()`é–¢æ•°
   - è¡Œç•ªå·: ç´„23è¡Œç›®
   - å¤‰æ›´: `if session.company:` â†’ `if session.mode == 'detailed' and session.company:`

3. **backend/spin/serializers.py**
   - `SessionSerializer.create()`ãƒ¡ã‚½ãƒƒãƒ‰
   - è¡Œç•ªå·: ç´„101è¡Œç›®
   - å¤‰æ›´: `if company_id:` â†’ `mode`ã®è¨­å®šã‚‚è¿½åŠ 

4. **frontend/app.js**
   - `loadChatHistory()`é–¢æ•°
   - è¡Œç•ªå·: ç´„1077è¡Œç›®
   - å¤‰æ›´: `if (data.company)` â†’ å¤‰æ›´ä¸è¦ï¼ˆAPIãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰

5. **frontend/app.js**
   - `displayCompanySummary()`é–¢æ•°
   - è¡Œç•ªå·: ç´„1094è¡Œç›®
   - å¤‰æ›´: å¤‰æ›´ä¸è¦ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰

### å¤‰æ›´ãŒå¿…è¦ãªç®‡æ‰€ã®è©³ç´°

| ãƒ•ã‚¡ã‚¤ãƒ« | é–¢æ•°/ãƒ¡ã‚½ãƒƒãƒ‰ | è¡Œç•ªå·ï¼ˆæ¨å®šï¼‰ | å¤‰æ›´å†…å®¹ | å„ªå…ˆåº¦ |
|---------|-------------|--------------|---------|--------|
| `backend/spin/models.py` | `Session`ãƒ¢ãƒ‡ãƒ« | 59-84 | `mode`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ  | é«˜ |
| `backend/spin/serializers.py` | `SessionSerializer` | 59-119 | `mode`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰è¿½åŠ ã€`validate`æ›´æ–° | é«˜ |
| `backend/spin/views.py` | `start_session` | 175-185 | ãƒ­ã‚°ã«`mode`è¿½åŠ  | ä¸­ |
| `backend/spin/services/openai_client.py` | `generate_customer_response` | 9-68 | `mode`ãƒã‚§ãƒƒã‚¯è¿½åŠ ã€ãƒ­ã‚°æ›´æ–° | é«˜ |
| `backend/spin/services/scoring.py` | `score_conversation` | 12-149 | `mode`ãƒã‚§ãƒƒã‚¯è¿½åŠ ã€ãƒ­ã‚°æ›´æ–° | é«˜ |
| `frontend/app.js` | `startDiagnosis` | 265-332 | `mode: 'simple'`è¿½åŠ  | ä¸­ |
| `frontend/app.js` | `startDetailedDiagnosis` | 462-564 | `mode: 'detailed'`è¿½åŠ  | ä¸­ |
| `frontend/app.js` | ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚° | è¤‡æ•°ç®‡æ‰€ | ãƒ­ã‚°ã«`mode`è¿½åŠ  | ä½ |

## ğŸ“‹ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

### ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ

```python
# backend/check_migration.py
from spin.models import Session

def check_data_integrity():
    """ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã®ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ã‚’ãƒã‚§ãƒƒã‚¯"""
    
    # 1. ã™ã¹ã¦ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«modeãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹
    total_sessions = Session.objects.count()
    sessions_with_mode = Session.objects.exclude(mode__isnull=True).count()
    
    if total_sessions != sessions_with_mode:
        print(f"ã‚¨ãƒ©ãƒ¼: modeãŒè¨­å®šã•ã‚Œã¦ã„ãªã„ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒã‚ã‚Šã¾ã™")
        print(f"  ç·ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: {total_sessions}")
        print(f"  modeè¨­å®šæ¸ˆã¿: {sessions_with_mode}")
        return False
    
    # 2. companyãŒã‚ã‚‹ã®ã«mode='simple'ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„ã‹
    simple_with_company = Session.objects.filter(
        company__isnull=False, 
        mode='simple'
    ).count()
    
    if simple_with_company > 0:
        print(f"ã‚¨ãƒ©ãƒ¼: companyãŒã‚ã‚‹ã®ã«mode='simple'ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒ{simple_with_company}ä»¶ã‚ã‚Šã¾ã™")
        return False
    
    # 3. companyãŒãªã„ã®ã«mode='detailed'ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒãªã„ã‹
    detailed_without_company = Session.objects.filter(
        company__isnull=True, 
        mode='detailed'
    ).count()
    
    if detailed_without_company > 0:
        print(f"ã‚¨ãƒ©ãƒ¼: companyãŒãªã„ã®ã«mode='detailed'ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒ{detailed_without_company}ä»¶ã‚ã‚Šã¾ã™")
        return False
    
    # 4. çµ±è¨ˆæƒ…å ±
    simple_count = Session.objects.filter(mode='simple').count()
    detailed_count = Session.objects.filter(mode='detailed').count()
    
    print(f"âœ“ ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ãƒã‚§ãƒƒã‚¯æˆåŠŸ")
    print(f"  ç°¡æ˜“è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰: {simple_count}ä»¶")
    print(f"  è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰: {detailed_count}ä»¶")
    print(f"  åˆè¨ˆ: {total_sessions}ä»¶")
    
    return True

if __name__ == '__main__':
    check_data_integrity()
```

**å®Ÿè¡Œæ–¹æ³•:**
```bash
cd backend
python manage.py shell < ../scripts/check_migration.py
```

**æ³¨æ„äº‹é …:**
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå¾Œã€å¿…ãšã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¦æ•´åˆæ€§ã‚’ç¢ºèª
- ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã£ãŸå ´åˆã¯ã€ã™ãã«ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æ¤œè¨

## ğŸ” å®Ÿè£…å‰ã®æœ€çµ‚ç¢ºèªãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç¢ºèª
- [ ] æ—¢å­˜ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: `Session.objects.count()`
- [ ] è©³ç´°è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: `Session.objects.filter(company__isnull=False).count()`
- [ ] ç°¡æ˜“è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³æ•°: `Session.objects.filter(company__isnull=True).count()`
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–å¾—æ¸ˆã¿

### ã‚³ãƒ¼ãƒ‰ç¢ºèª
- [ ] `session.company`ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦ã„ã‚‹ç®‡æ‰€ã‚’ç‰¹å®šæ¸ˆã¿
- [ ] `SessionSerializer`ã®ä½¿ç”¨ç®‡æ‰€ã‚’ç¢ºèªæ¸ˆã¿
- [ ] æ—¢å­˜ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒé©ç”¨ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªæ¸ˆã¿
- [ ] æœ€æ–°ã®ã‚³ãƒŸãƒƒãƒˆã‚’ãƒªãƒ¢ãƒ¼ãƒˆã«ãƒ—ãƒƒã‚·ãƒ¥æ¸ˆã¿

### ãƒ†ã‚¹ãƒˆç’°å¢ƒç¢ºèª
- [ ] ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãŒæœ€æ–°ã®çŠ¶æ…‹
- [ ] ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ãŒæº–å‚™ã•ã‚Œã¦ã„ã‚‹ï¼ˆã¾ãŸã¯æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã§ãƒ†ã‚¹ãƒˆå¯èƒ½ï¼‰
- [ ] ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãŒå–å¾—ã§ãã‚‹
- [ ] Dockerã‚³ãƒ³ãƒ†ãƒŠãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹

### å®Ÿè£…æº–å‚™
- [ ] æ”¹å–„è¨ˆç”»æ›¸ã‚’ç¢ºèªæ¸ˆã¿
- [ ] ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ‰‹é †ã‚’ç†è§£æ¸ˆã¿
- [ ] æ¤œè¨¼ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œæ–¹æ³•ã‚’ç†è§£æ¸ˆã¿

## ğŸ“… å®Ÿè£…ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³

1. **æº–å‚™ãƒ•ã‚§ãƒ¼ã‚º**ï¼ˆ30åˆ†ï¼‰
   - æ”¹å–„è¨ˆç”»ã®ç¢ºèª
   - ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®å–å¾—
   - ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®æº–å‚™

2. **ãƒ¢ãƒ‡ãƒ«ãƒ»ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚§ãƒ¼ã‚º**ï¼ˆ30åˆ†ï¼‰
   - ãƒ¢ãƒ‡ãƒ«ã®æ›´æ–°
   - ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ
   - ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ

3. **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰æ›´æ–°ãƒ•ã‚§ãƒ¼ã‚º**ï¼ˆ1æ™‚é–“ï¼‰
   - ã‚·ãƒªã‚¢ãƒ©ã‚¤ã‚¶ãƒ¼ã®æ›´æ–°
   - ãƒ“ãƒ¥ãƒ¼ã®æ›´æ–°
   - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®æ›´æ–°
   - ãƒ†ã‚¹ãƒˆ

4. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰æ›´æ–°ãƒ•ã‚§ãƒ¼ã‚º**ï¼ˆ30åˆ†ï¼‰
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³é–‹å§‹æ™‚ã®`mode`é€ä¿¡
   - ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®æ”¹å–„
   - ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®å‹•ä½œç¢ºèª

5. **çµ±åˆãƒ†ã‚¹ãƒˆãƒ•ã‚§ãƒ¼ã‚º**ï¼ˆ30åˆ†ï¼‰
   - å…¨ä½“å‹•ä½œã®ç¢ºèª
   - ã‚¨ãƒ©ãƒ¼ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆ
   - æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª

**åˆè¨ˆ: ç´„3æ™‚é–“**

## ğŸ¯ æœŸå¾…ã•ã‚Œã‚‹åŠ¹æœ

1. **å•é¡Œã®åˆ‡ã‚Šåˆ†ã‘ãŒå®¹æ˜“ã«ãªã‚‹**
   - ãƒ­ã‚°ã«`mode`æƒ…å ±ãŒå«ã¾ã‚Œã‚‹ãŸã‚ã€ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚ã«ã©ã¡ã‚‰ã®ãƒ¢ãƒ¼ãƒ‰ã§å•é¡ŒãŒèµ·ããŸã‹ãŒæ˜ç¢º
   
2. **ãƒ‡ãƒãƒƒã‚°ãŒç°¡å˜ã«ãªã‚‹**
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ä¸€è¦§ã§ãƒ¢ãƒ¼ãƒ‰ã‚’ç¢ºèªã§ãã‚‹
   - ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®çµ±è¨ˆã‚’å–å¾—ã§ãã‚‹

3. **å°†æ¥ã®æ‹¡å¼µã«å¯¾å¿œã§ãã‚‹**
   - æ–°ã—ã„ãƒ¢ãƒ¼ãƒ‰ï¼ˆä¾‹ï¼šãƒ—ãƒ¬ãƒŸã‚¢ãƒ è¨ºæ–­ãƒ¢ãƒ¼ãƒ‰ï¼‰ã‚’è¿½åŠ ã—ã‚„ã™ã„
   - ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®æ©Ÿèƒ½ã‚’è¿½åŠ ã—ã‚„ã™ã„

4. **ã‚³ãƒ¼ãƒ‰ã®ä¿å®ˆæ€§ãŒå‘ä¸Š**
   - ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã‚‹å‡¦ç†åˆ†å²ãŒæ˜ç¢ºã«ãªã‚‹
   - å„ãƒ¢ãƒ¼ãƒ‰ã®è²¬ä»»ãŒæ˜ç¢ºã«ãªã‚‹

