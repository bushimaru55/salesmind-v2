# モード選択機能の設計仕様

## 概要
SalesMindシステムを2つのモードに分け、ユーザーが用途に応じて選択できるようにする。

---

## モード一覧

### 1. 簡易診断モード（現在のモード）
**概要**: 企業情報を取得せず、手動で基本情報を入力してSPIN質問を生成するモード

**フロー**:
1. 業界・価値提案・顧客像・顧客の課題を手動入力
2. SPIN質問生成
3. セッション開始
4. チャット（AI顧客応答）
5. スコアリング

**特徴**:
- 手軽に使える
- 企業情報は不要
- 一般的な質問生成が可能

---

### 2. 詳細診断モード（新規追加）
**概要**: 企業情報をスクレイピングで取得し、その情報を活用した詳細な診断を行うモード

**フロー**:
1. 企業情報取得
   - 方法A: 企業URLを入力してスクレイピング
   - 方法B: sitemap.xmlをアップロードして複数URLからスクレイピング
2. 企業情報の表示・確認
3. 価値提案入力（オプション）
4. SPIN適合性分析（オプション、価値提案がある場合）
5. SPIN質問生成（企業情報を活用）
6. セッション開始（企業情報・分析結果を紐付け）
7. チャット（企業情報を活用したAI顧客応答）
8. スコアリング（企業情報を考慮）

**特徴**:
- 実際の企業情報に基づく具体的な質問生成
- 企業の課題を推測して反映
- SPIN適合性スコアによる提案アプローチの最適化
- より実践的なトレーニングが可能

---

## UI設計

### モード選択画面
- アプリ起動時、またはログイン後に最初に表示
- 2つのカード形式でモードを選択
- 各モードの説明を表示

### 簡易診断モード画面
- 現在のUIをそのまま維持
- ステップ1〜5のフロー

### 詳細診断モード画面
- **ステップ0**: モード選択（既に選択済み）
- **ステップ1**: 企業情報取得
  - URL入力 or sitemap.xmlアップロード
  - スクレイピング実行ボタン
  - ローディング表示
  - エラーハンドリング
- **ステップ2**: 企業情報確認
  - 企業名・業界・事業内容・所在地などを表示
  - 価値提案入力（オプション）
  - SPIN適合性分析ボタン（価値提案がある場合）
  - 分析結果表示（スコア・推奨事項）
- **ステップ3**: SPIN質問生成
  - 企業情報を活用してSPIN質問を生成
  - 生成された質問を表示
- **ステップ4**: セッション開始
  - 企業情報・分析結果をセッションに紐付け
- **ステップ5**: チャット
  - 企業情報を参照したAI顧客応答
- **ステップ6**: スコアリング
  - 企業情報を考慮したスコアリング

---

## データフロー

### 簡易診断モード
```
手動入力（業界、価値提案等）
  ↓
SPIN質問生成API
  ↓
セッション作成（company_idなし）
  ↓
チャット（企業情報なし）
  ↓
スコアリング（企業情報なし）
```

### 詳細診断モード
```
企業URL入力 / sitemap.xmlアップロード
  ↓
企業スクレイピングAPI → Companyモデル作成
  ↓
（オプション）価値提案入力
  ↓
（オプション）SPIN適合性分析API → CompanyAnalysisモデル作成
  ↓
SPIN質問生成API（企業情報を参照）
  ↓
セッション作成（company_id, company_analysis_idを紐付け）
  ↓
チャット（企業情報を参照したAI応答）
  ↓
スコアリング（企業情報を考慮）
```

---

## API変更点

### 既存APIの活用
- `/api/company/scrape/` - 企業URLスクレイピング（詳細診断モードで使用）
- `/api/company/scrape-from-sitemap/` - sitemap.xmlからのスクレイピング（詳細診断モードで使用）
- `/api/company/analyze/` - SPIN適合性分析（詳細診断モードで使用）

### API拡張（必要に応じて）
- `POST /api/spin/generate/` - オプショナルで`company_id`を受け取り、企業情報を参照して質問生成
- `POST /api/session/start/` - 既に`company_id`, `company_analysis_id`をサポート（拡張不要）

### チャット・スコアリングAPIの拡張
- 既存のAPIが`Session`モデルを参照するため、自動的に企業情報が利用される
- `generate_customer_response`で企業情報を参照する処理を追加
- `score_conversation`で企業情報を参照する処理を追加

---

## 実装フェーズ

### Phase 1: モード選択UIの追加
- [ ] モード選択画面のHTML追加
- [ ] モード選択のJavaScript実装
- [ ] モード状態の管理（localStorage）

### Phase 2: 詳細診断モードのステップ1（企業情報取得）
- [ ] 企業URL入力フォーム
- [ ] sitemap.xmlアップロード機能
- [ ] スクレイピングAPI呼び出し
- [ ] ローディング・エラーハンドリング

### Phase 3: 詳細診断モードのステップ2（企業情報確認・分析）
- [ ] 企業情報表示UI
- [ ] 価値提案入力フォーム
- [ ] SPIN適合性分析API呼び出し
- [ ] 分析結果表示UI

### Phase 4: 詳細診断モードのステップ3以降
- [ ] SPIN質問生成（企業情報を参照）
- [ ] セッション開始（企業情報を紐付け）
- [ ] チャット（企業情報を参照した応答）
- [ ] スコアリング（企業情報を考慮）

### Phase 5: バックエンド拡張（必要に応じて）
- [ ] `generate_spin`で企業情報を参照
- [ ] `generate_customer_response`で企業情報を参照
- [ ] `score_conversation`で企業情報を参照

---

## 考慮事項

### ユーザビリティ
- モード切り替えは可能だが、セッション途中では切り替え不可
- 詳細診断モードは企業情報取得が必要なため、ステップが多い
- 各ステップで「前へ戻る」ボタンを提供

### パフォーマンス
- スクレイピングは時間がかかる可能性がある（最大50URL）
- ローディング表示を適切に実装
- タイムアウト処理を実装

### エラーハンドリング
- スクレイピング失敗時のエラーメッセージ
- 企業情報が取得できなかった場合のフォールバック
- ネットワークエラーの処理

---

## 変更履歴
- 2025-11-03: 初版作成

